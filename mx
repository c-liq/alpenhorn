CC=gcc
CFLAGS=-std=gnu99 -O3 -fomit-frame-pointer -g -I lib -I include/ -I /usr/local/include -L /usr/local/lib -lgmp -lsodium -lm -pthread -lpbc -Wl,-rpath /usr/local/lib


DCLXCI_SRC_DIR=lib/dclxci

BN256_FILES= fpe.c fp2e.c scalar.c parameters.c \
             twistpoint_fp2.c mul.c mydouble.c curvepoint_fp.c \
			 twistpoint_fp2_multiscalar.c heap_rootreplaced.s \
             index_heap.c scalar_sub_nored.s fp12e.c fpe.c fp2e.c fp6e.c \
             optate.c linefunction.c final_expo.c gmp_convert.c

BN256_SOURCES=$(addprefix $(DCLXCI_SRC_DIR)/, $(BN256_FILES))


COMMON_SOURCE_FILES=$(src/net_common.c src/utils.c include/config.h asfunctions.a)
CLIENT_SOURCE_FILES=$(addprefix src/, client.c client_net.c bn256.c bn256_ibe.c bn256_bls.c keywheel_table.c bloom.c prime_gen.c)
PKG_SOURCE_FILES=$(addprefix src/, pkg.c pkg_net.c )
             


all: client


client: $(CLIENT_SOURCE_FILES) $(BN256_SOURCES) asfunctions.a lib/xxhash/xxhash.c
	$(CC) $(CFLAGS) $(LFLAGS) -DQHASM -o $@ $^ $(COMMON_SOURCE_FILES)




test_ibe: include/config.h src/pkg.c src/bloom.c src/prime_gen.c src/keywheel_table.c \
           			 src/net_common.c src/utils.c lib/xxhash/xxhash.c src/bn256_ibe.c src/bn256_bls.c src/bn256.c \
			tests/test_bn256_ibe.c src/client.c src/pkg.c src/mix.c src/utils.c include/config.h $(BN256_SOURCES)
	$(CC) $(CFLAGS) $(LFLAGS) -DQHASM -o $@ $^ asfunctions.a


%.o: lib/dclxci/%.s
	$(CC) -std=gnu99 -O3 -fomit-frame-pointer -c -o $@ $^

asfunctions.a: fp2e_add2.o fp2e_sub2.o \
	fp2e_double2.o fp2e_triple2.o fp2e_neg2.o \
	fp2e_mul.o fp2e_mul_fpe.o fp2e_short_coeffred.o \
	fp2e_add.o fp2e_sub.o fp2e_parallel_coeffmul.o fp2e_mulxi.o\
	fp2e_double.o fp2e_triple.o fp2e_neg.o fp2e_conjugate.o \
	fpe_mul.o fp2e_square.o \
	consts.o
	rm -f asfunctions.a
	ar cr asfunctions.a $^

clean:
	-rm -f client


